<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./lib/css/reset.css" />
    <link rel="stylesheet" href="./lib/css/fonts.css" />
    <link rel="stylesheet" href="./lib/css/style.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      function initAutocomplete() {
        var input = document.getElementById("autocomplete");
        var options = {
          type: ["golf_course"],
          componentRestrictions: { country: "kr" },
        };
        var autocomplete = new google.maps.places.Autocomplete(input, options);

        autocomplete.addListener("place_changed", handlePlaceSelect);
      }

      function handlePlaceSelect() {
        var place = this.getPlace();
        var types = place.types;
        var PLC_ID = place.place_id;
        var PLC_NM = place.name;

        $("#PLC_ID").val(PLC_ID);
        $("#PLC_NM").val(PLC_NM);
        $("#autocomplete").val(PLC_NM);
        localStorage.setItem("PLC_NM", PLC_NM);
      }

      $(document).ready(function () {
        const HZ_LNTH_MIN = 38;
        const HZ_LNTH_MAX = 60;
        const VR_LNTH_MIN = 27;
        const VR_LNTH_MAX = 45;
        $("input[type='text'], input[type='number']").on("input", function () {
          if (
            $("#USER_NICK").val() !== "" &&
            $("#autocomplete").val() !== "" &&
            $("#HZ_LNTH").val() !== "" &&
            $("#VR_LNTH").val() !== ""
          ) {
            var hz_ln = parseInt($("#HZ_LNTH").val());
            var vr_ln = parseInt($("#VR_LNTH").val());
            var hz_valid = !isNaN(hz_ln) && hz_ln >= HZ_LNTH_MIN && hz_ln <= HZ_LNTH_MAX;
            var vr_valid = !isNaN(vr_ln) && vr_ln >= VR_LNTH_MIN && vr_ln <= VR_LNTH_MAX;
            if (hz_valid && vr_valid) {
              $("button[type='submit']").prop("disabled", false);
            } else {
              $("button[type='submit']").prop("disabled", true);
              alert(
                "최소값: " +
                  HZ_LNTH_MIN +
                  " x " +
                  VR_LNTH_MIN +
                  ", 최대값: " +
                  HZ_LNTH_MAX +
                  " x " +
                  VR_LNTH_MAX
              );
            }
          } else {
            $("button[type='submit']").prop("disabled", true);
          }
        });

        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src =
          "https://maps.googleapis.com/maps/api/js?key=AIzaSyBFRWvAechU0Ztnm5KDWl1FwAUt6as_3fQ&libraries=places&callback=initAutocomplete";
        document.body.appendChild(script);

        $("form").submit(function (event) {
          event.preventDefault();

          const params = {
            PLC_ID: $("#PLC_ID").val(),
          };

          $.ajax({
            url: "https://ji40ssrbe6.execute-api.ap-northeast-2.amazonaws.com/v1/checkFlagEvnt",
            type: "POST",
            data: JSON.stringify(params),
            contentType: "application/json",
            success: function (data) {
              //console.log("success:", data);
              if (data.statusCode === 400 || data.statusCode === 409) {
                openFailPopup();
              } else {
                openSuccessPopup();
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              alert("서버와 통신 중 오류가 발생하였습니다.");
            },
          });
        });
      });

      function handlePopupClose(isGolfPlace) {
        if (!isGolfPlace) {
          sessionStorage.removeItem("PLC_NM");
          $("#PLC_ID").val("");
          $("#PLC_NM").val("");
          $("#autocomplete").val("");
        }
      }

      function openSuccessPopup() {
        if (
          $("#autocomplete").val() === "" ||
          $("#autocomplete").val() === null ||
          $("#autocomplete").val() === undefined
        ) {
          alert("골프장을 입력해주세요");
          $("#autocomplete").focus();
          $("input[type='submit']").prop("disabled", true);
          return;
        }
        var PLC_NM = localStorage.getItem("PLC_NM");
        if (!PLC_NM) {
          alert("골프장을 입력해주세요");
          $("#autocomplete").focus();
          $("input[type='submit']").prop("disabled", true);
          return;
        }

        var inputElement = document.getElementById("golfPlaceInput");
        inputElement.value = "";
        inputElement.value = PLC_NM;
        var popupWindow = window.open("successPopup.html");
        popupWindow.onbeforeunload = function () {};
      }

      function openFailPopup() {
        if (
          $("#autocomplete").val() === "" ||
          $("#autocomplete").val() === null ||
          $("#autocomplete").val() === undefined
        ) {
          alert("골프장을 입력해주세요");
          $("#autocomplete").focus();
          $("input[type='submit']").prop("disabled", true);
          return;
        }
        var PLC_NM = sessionStorage.getItem("PLC_NM");
        var popupWindow = window.open("failPopup.html");
        popupWindow.onbeforeunload = function () {
          handlePopupClose(isGolfPlace);
        };
      }

      function onSave() {
        if (
          $("#USER_NICK").val() === "" ||
          $("#USER_NICK").val() === null ||
          $("#USER_NICK").val() === undefined
        ) {
          alert("카카오 ID를 입력해주세요");
          $("#USER_NICK").focus();
          return;
        }

        if (
          $("#golfPlaceInput").val() === "" ||
          $("#golfPlaceInput").val() === null ||
          $("#golfPlaceInput").val() === undefined
        ) {
          alert("골프장을 입력해주세요");
          $("#golfPlaceInput").focus();
          $("input[type='submit']").prop("disabled", true);
          return;
        }

        if (!$("input[name='radio']:checked").val()) {
          alert("동의 여부를 선택해주세요.");
          return;
        }

        if (
          $("#HZ_LNTH").val() === "" ||
          $("#HZ_LNTH").val() === null ||
          $("#HZ_LNTH").val() === undefined
        ) {
          alert("가로 길이를 입력해주세요");
          $("#HZ_LNTH").focus();
          return;
        }

        if (
          $("#VR_LNTH").val() === "" ||
          $("#VR_LNTH").val() === null ||
          $("#VR_LNTH").val() === undefined
        ) {
          alert("세로 길이를 입력해주세요");
          $("#VR_LNTH").focus();
          return;
        }

        if (confirm("깃발을 등록하시겠습니까?")) {
          // 깃발을 등록합니다.
          const params = {
            PLC_ID: $("#PLC_ID").val(),
            PLC_NM: $("#PLC_NM").val(),
            UNIT_NM: $("#UNIT_NM").val(),
            HZ_LNTH: $("#HZ_LNTH").val(),
            VR_LNTH: $("#VR_LNTH").val(),
            REG_ID: $("#USER_NICK").val(),
            REG_NICK: $("#USER_NICK").val(),
            USE_YN: $("#USE_YN").val(),
          };

          $.ajax({
            url: "https://ji40ssrbe6.execute-api.ap-northeast-2.amazonaws.com/v1/flagEvnt",
            type: "POST",
            data: JSON.stringify(params),
            contentType: "application/json",
            success: function (data) {
              //console.log("success:", data);
              if (data.statusCode === 409) {
                alert("해당 골프장에 깃발을 이미 등록했습니다.");
              } else if (data.statusCode === 400) {
                alert("해당 골프장은 깃발이 모두 등록되었습니다.");
              } else if (data.statusCode === 403) {
                alert("하나의 계정은 깃발을 열 개까지 등록할 수 있습니다.");
              } else {
                alert("등록이 완료되었습니다.");
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              alert("서버와 통신 중 오류가 발생하였습니다.");
            },
          });
        }
      }

      function Search() {
        //console.log($("#USER_NICK").val());
        //console.log($("#PLC_NM").val());
        if (
          $("#USER_NICK").val() === "" ||
          $("#USER_NICK").val() === null ||
          $("#USER_NICK").val() === undefined
        ) {
          alert("카카오 ID를 입력해주세요");
          $("#USER_NICK").focus();
          $("button[type='submit']").prop("disabled", true);
          return;
        }

        if (
          $("#golfPlaceInput").val() === "" ||
          $("#golfPlaceInput").val() === null ||
          $("#golfPlaceInput").val() === undefined
        ) {
          alert("골프장을 입력해주세요");
          $("#golfPlaceInput").focus();
          $("button[type='submit']").prop("disabled", true);
          return;
        }

        const params = {
          PLC_ID: $("#PLC_ID").val(),
          PLC_NM: $("#PLC_NM").val(),
          REG_NICK: $("#USER_NICK").val(),
        };
        $.ajax({
          url: "https://ji40ssrbe6.execute-api.ap-northeast-2.amazonaws.com/v1/checkFlagEvnt",
          type: "POST",
          data: JSON.stringify(params),
          contentType: "application/json",
          success: function (data) {
            //console.log("success:", data);
            if (data.statusCode === 409) {
              alert("해당 골프장에 깃발을 이미 등록했습니다.");
            } else if (data.statusCode === 400) {
              alert("해당 골프장은 깃발이 모두 등록되었습니다.");
            } else if (data.statusCode === 403) {
              alert("하나의 계정은 깃발을 열 개까지 등록할 수 있습니다.");
            } else {
              alert("등록이 가능합니다.");
            }
          },
          error: function (jqXHR, textStatus, errorThrown) {
            alert("서버와 통신 중 오류가 발생하였습니다.");
          },
        });
      }

      $.ajax({
        url: "https://ji40ssrbe6.execute-api.ap-northeast-2.amazonaws.com/v1/FlagEvntRank",
        type: "GET",
        contentType: "application/json",
        success: function (response) {
          const data = JSON.parse(response.body);
          let rankHtml = "";
          data.forEach((item, index) => {
            const rankClass =
              index === 0
                ? "first"
                : index === 1
                ? "second"
                : index === 2
                ? "third"
                : index === 3
                ? "fourth"
                : "fifth";
            const rankElement = `
            <div class="rating_item">
              <div class="rating_star ${rankClass}">${index + 1}등</div>
              <p class="phone_num">${item[0]}</p>
              <p class="num_time">${item[1]}회</p>
            </div>
          `;
            rankHtml += rankElement;
          });
          $(".rating_box").html(rankHtml);
        },
        error: function (jqXHR, textStatus, errorThrown) {
          alert("서버와 통신 중 오류가 발생하였습니다.");
        },
      });

      $(document).ready(fetchRanking);
    </script>
  </head>
  <body>
    <div class="wrap">
      <div class="section">
        <img src="../lib/img/top_bg.png" alt="" />
      </div>
      <div class="section">
        <h3 class="section_title">경품안내</h3>
        <!-- 경품 이미지 확정시 이미지 넣기 -->
        <div class="event_table prize">이미지 사진</div>
        <p class="warning_phrase">- 경품 이미지는 실제와 다를 수 있습니다.</p>
      </div>
      <div class="section">
        <h3 class="section_title">이벤트 안내</h3>
        <div class="event_table">
          <div class="table_left">
            <p>이벤트 기간</p>
            <p>이벤트 대상</p>
            <p>혜택지급일</p>
          </div>
          <div class="table_right">
            <p>1차 이벤트 5월 15일~6월 14일(1개월간 진행)</p>
            <p>캐디, 야외골프장 깃발 크기 측정자</p>
            <p>2023년 6월 14일(수) 이후 1개월 내 순차지급</p>
          </div>
        </div>
      </div>
      <div class="section">
        <h3 class="section_title">1차 이벤트 참여하기</h3>
        <div class="event_table vertical first">
          <div class="table_tab">
            <p class="active">STEP 01</p>
            <p>STEP 02</p>
            <p>STEP 03</p>
          </div>
          <form>
            <div class="tab_content">
              <h5 class="tab_title">이벤트 참여 가능 골프장 조회</h5>
              <div class="input_box search">
                <input
                  type="text"
                  id="autocomplete"
                  name="autocomplete"
                  placeholder="이벤트에 참여할 골프장을 검색하세요."
                />
                <input type="hidden" id="PLC_ID" name="PLC_ID" />
                <input type="hidden" id="PLC_NM" name="PLC_NM" />
              </div>
              <div class="btn_wrap">
                <button>조회</button>
              </div>
              <p class="warning_phrase">
                - 한 개의 골프장당 최대 3명까지 참여가 가능합니다.
              </p>
              <p class="warning_phrase">
                - '참여불가'상태의 골프장은 참여하셔도 보상이 불가합니다.
              </p>
            </div>
          </form>
        </div>
        <div class="event_table vertical">
          <div class="table_tab">
            <p>STEP 01</p>
            <p class="active">STEP 02</p>
            <p>STEP 03</p>
          </div>
          <div class="tab_content">
            <h5 class="tab_title">깃발 가로x세로 크기 측정</h5>
            <div class="tab_row">
              <div class="tab_text">
                <p>카카오ID</p>
              </div>
              <div class="input_box">
                <input type="hidden" id="USER_ID" value="USER_ID" />
                <input
                  type="text"
                  id="USER_NICK"
                  name="USER_NICK"
                  placeholder="카카오톡 아이디를 입력해주세요."
                />
              </div>
              <div class="transparent"></div>
            </div>
            <div class="tab_row">
              <div class="tab_text">
                <p>골프장</p>
              </div>
              <div class="input_box">
                <input
                  type="text"
                  id="golfPlaceInput"
                  placeholder="깃발크기를 측정한 골프장을 입력하세요."
                />
                <input type="hidden" id="UNIT_NM" value="cm" />
                <input type="hidden" id="USE_YN" value="Y" />
              </div>
              <div class="btn_wrap">
                <button onclick="Search()">검색</button>
              </div>
            </div>
            <div class="tab_row">
              <div class="tab_text">
                <p>깃발크기</p>
              </div>
              <div class="input_wrap">
                <div class="input_box">
                  <input type="text" id="HZ_LNTH" name="HZ_LNTH" placeholder="가로(cm)" />
                </div>
                <span>X</span>
                <div class="input_box">
                  <input type="text" id="VR_LNTH" name="VR_LNTH" placeholder="세로(cm)" />
                </div>
                <p id="input-guide"></p>
              </div>
              <div class="transparent"></div>
            </div>
            <div class="warning_box">
              <p class="warning_phrase">
                - 깃발 크기가 정확하지 않을 경우 보상 대상에서 제외될 수 있습니다.
              </p>
              <p class="warning_phrase">
                - 이벤트 1회 기준 인당 최대 10번까지 참여가 가능합니다.
              </p>
              <p class="warning_phrase">
                - 가장 정확한 수치로 깃발을 많이 등록해주시는 분들께 추가 보상을 드립니다.
              </p>
            </div>
          </div>
        </div>
        <div class="event_table vertical">
          <div class="table_tab">
            <p>STEP 01</p>
            <p>STEP 02</p>
            <p class="active">STEP 03</p>
          </div>
          <div class="tab_content">
            <h5 class="tab_title">개인정보 수집 및 이용에 동의해 주세요.</h5>
            <p class="tab_title_sub">
              이벤트 경품 지급을 위해서만 개인정보를 이용하며<br />
              이벤트 완료 후 1개월 이내에 모든 정보는 파기됩니다.
            </p>
            <div class="radio_wrap">
              <label class="radio_box">
                <input type="radio" name="radio" />
                <span class="radio_btn"></span>
                <span class="radio_txt">네,동의합니다.</span>
              </label>
              <label class="radio_box">
                <input type="radio" name="radio" />
                <span class="radio_btn"></span>
                <span class="radio_txt">동의하지 않습니다.</span>
              </label>
            </div>
            <br />
            <div>
              <p id="input-guide"></p>
            </div>
            <div class="btn_wrap">
              <button type="submit" onclick="onSave()">제출하기</button>
            </div>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="section_title_box">
          <h3 class="section_title">실시간 참여 랭킹</h3>
          <p></p>
        </div>
        <script>
          function getCurrentDateTimeString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const weekday = ["일", "월", "화", "수", "목", "금", "토"][now.getDay()];
            const hours = now.getHours();
            const ampm = hours < 12 ? "오전" : "오후";
            const formattedHours = String(hours % 12 || 12).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");

            return `${year}년 ${month}월 ${day}일 ${weekday}요일 ${ampm} ${formattedHours}:${minutes} 기준`;
          }

          window.onload = function () {
            document.querySelector(".section_title_box p").textContent =
              getCurrentDateTimeString();
          };
        </script>
        <div class="event_table vertical">
          <div class="rating_box">
            <div class="rating_item">
              <div class="rating_star first">1등</div>
              <p class="phone_num">kakao***</p>
              <p class="num_time">10회</p>
            </div>
            <div class="rating_item">
              <div class="rating_star second">2등</div>
              <p class="phone_num">kakao***</p>
              <p class="num_time">10회</p>
            </div>
            <div class="rating_item">
              <div class="rating_star third">3등</div>
              <p class="phone_num">kakao***</p>
              <p class="num_time">10회</p>
            </div>
            <div class="rating_item">
              <div class="rating_star fourth">4등</div>
              <p class="phone_num">kakao***</p>
              <p class="num_time">10회</p>
            </div>
            <div class="rating_item">
              <div class="rating_star fifth">5등</div>
              <p class="phone_num">kakao***</p>
              <p class="num_time">10회</p>
            </div>
          </div>
          <div class="rating_warning">
            <p class="warning_phrase">- 랭킹 TOP5에게는 앱 1년 무료 이용권이 지급되며,</p>
            <p class="warning_phrase">
              TOP3에게는 앱 1년 무료 이용권과 함께 <span>"미니 골드바" 추가 보상</span>을
              드립니다.
            </p>
            <p class="warning_phrase">
              - 참여 횟수가 동일할 경우 선착순으로 보상이 지급됩니다.
            </p>
          </div>
        </div>
      </div>
      <div class="section">
        <h3 class="section_title">유의사항</h3>
        <div class="precautions">
          <p>-하나의 골프장당 최초 1회만 참여가 가능하니 신중히 입력해주시길 바립니다.</p>
          <p>
            -정확도가 낮은 측정 결과 또는 비정상적인 입력은 별도의 통보 없이 보상 대상에서
            제외됩니다.
          </p>
          <p>
            -이벤트 조건이 충족되지 않을 경우, 정상제출ㅇ이 되어도 보상 지급이 불가합니다.
          </p>
          <p>-이벤트 기간 내에 해당 웹페이지에서<제출하기>버튼을 누르셔야 신청됩니다.</p>
          <p>
            -보상받을 전화번호 정보 불일치, 연락 두절로 인한 재발송은 진행하지 않습니다.
          </p>
          <p>
            -보상 지급 시점은 이벤트 종료 후 깃발 크기 데이터 확인 후 1개월 이내입니다.
          </p>
          <p>
            -본 이벤트는 당사 사정에 의하여 예고 없이 변경 또는 조기 동료될 수 있습니다.
          </p>
          <p>-야외골프장 깃발 거리 측정이 가능한 캐디 대상의 이벤트입니다.</p>
          <p>-해당 경품 이벤트는 만00세 이상 참여 가능합니다.</p>
          <p>
            -지급되는 보상은 참여해주신 횟수와 정확도에 따라 다르며, 참여 횟수는 실시간
            랭킹을 참고해주시기를 바랍니다.
          </p>
          <p>
            -보상은 안내된 상품권/상품으로 제공되며, 상황에 따라 경품이 변경 지급될 수
            있습니다.
          </p>
          <p>
            -기프티콘은 유효기간이 정해진 상품이며 해당 기간 내에 사용하지 않은 부분에
            대한 책임은 지지 않습니다.
          </p>
          <p>
            -이벤트 당첨 발표는 별도로 진행하지 않으며 당첨자분들에게 개별적으로
            연락드립니다.
          </p>
          <p>
            -수집된 개인정보는 당첨자 선정 및 경품 발송을 위해서만 사용되며, 이벤트 종료
            후 30일 이내 폐기됩니다.
          </p>
          <p>-이벤트 보상 사진은 연출된 이미지로 실제와 다를 수 있습니다.</p>
          <p>-본 이벤트는 당사 및 제휴사 사정에 따라 변경될 수 있습니다.</p>
        </div>
      </div>
    </div>
  </body>
</html>
